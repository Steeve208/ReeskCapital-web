<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema de Miner√≠a Completo - RSC Chain</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #00d4ff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #ccc;
            font-size: 1.2em;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .test-section h2 {
            color: #00d4ff;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-card h3 {
            color: #4ecdc4;
            margin-top: 0;
        }
        
        .test-btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.4);
        }
        
        .test-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-connected { background: #4ecdc4; }
        .status-disconnected { background: #ff6b6b; }
        .status-pending { background: #feca57; }
        
        .log-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
        }
        
        .log-success { background: rgba(78, 205, 196, 0.2); color: #4ecdc4; }
        .log-error { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .log-info { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .log-warning { background: rgba(254, 202, 87, 0.2); color: #feca57; }
        
        .mining-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin: 20px 0;
        }
        
        .mining-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #ccc;
            font-size: 0.9em;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .clear-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Test Sistema de Miner√≠a Completo</h1>
            <p>Verificaci√≥n completa de la integraci√≥n RSC Mining + Supabase</p>
        </div>

        <!-- Estado de Conexi√≥n -->
        <div class="test-section">
            <h2>
                <span class="status-indicator" id="connectionStatus">‚óè</span>
                Estado de Conexi√≥n
            </h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>üîó Supabase</h3>
                    <p id="supabaseStatus">Verificando conexi√≥n...</p>
                    <button class="test-btn" onclick="testSupabaseConnection()">Test Conexi√≥n</button>
                </div>
                
                <div class="test-card">
                    <h3>üîê Autenticaci√≥n</h3>
                    <p id="authStatus">No autenticado</p>
                    <button class="test-btn" onclick="testAuthentication()">Test Auth</button>
                    <button class="test-btn" onclick="forceAuthentication()" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);">üîê Forzar Auth</button>
                </div>
                
                <div class="test-card">
                    <h3>‚ö° Sistema de Miner√≠a</h3>
                    <p id="miningStatus">No inicializado</p>
                    <button class="test-btn" onclick="testMiningSystem()">Test Mining</button>
                </div>
            </div>
        </div>

        <!-- Controles de Miner√≠a -->
        <div class="test-section">
            <h2>‚õèÔ∏è Controles de Miner√≠a</h2>
            <div class="mining-controls">
                <button class="test-btn" id="startMiningBtn" onclick="startMining()">üöÄ Iniciar Miner√≠a</button>
                <button class="test-btn" id="stopMiningBtn" onclick="stopMining()" disabled>‚èπÔ∏è Detener Miner√≠a</button>
                <button class="test-btn" id="claimBtn" onclick="claimRewards()" disabled>üéÅ Reclamar RSC</button>
                <button class="test-btn" onclick="refreshData()">üîÑ Actualizar Datos</button>
            </div>
            
            <div class="mining-stats">
                <div class="stat-card">
                    <div class="stat-value" id="hashRate">0 H/s</div>
                    <div class="stat-label">Hash Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="minedRSC">0.000000 RSC</div>
                    <div class="stat-label">RSC Minados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeTime">00:00:00</div>
                    <div class="stat-label">Tiempo Activo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="userLevel">Nivel 1</div>
                    <div class="stat-label">Nivel Usuario</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="sessionProgress"></div>
            </div>
            <p id="sessionTimeRemaining">Sesi√≥n no iniciada</p>
        </div>

        <!-- Base de Datos -->
        <div class="test-section">
            <h2>üóÑÔ∏è Base de Datos</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>üë• Tabla Miners</h3>
                    <p id="minersStatus">Verificando...</p>
                    <button class="test-btn" onclick="testMinersTable()">Test Miners</button>
                </div>
                
                <div class="test-card">
                    <h3>üí∞ Tabla Transactions</h3>
                    <p id="transactionsStatus">Verificando...</p>
                    <button class="test-btn" onclick="testTransactionsTable()">Test Transactions</button>
                </div>
                
                <div class="test-card">
                    <h3>‚è±Ô∏è Tabla Sessions</h3>
                    <p id="sessionsStatus">Verificando...</p>
                    <button class="test-btn" onclick="testSessionsTable()">Test Sessions</button>
                </div>
            </div>
        </div>

        <!-- Log de Eventos -->
        <div class="test-section">
            <h2>üìã Log de Eventos</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">[Sistema] P√°gina cargada, inicializando...</div>
            </div>
            <button class="clear-btn" onclick="clearLog()">Limpiar Log</button>
        </div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <!-- Scripts de integraci√≥n -->
    <script src="scripts/supabase-mining-integration.js"></script>
    <script src="scripts/mining-ui-manager.js"></script>
    <script src="scripts/auth-manager.js"></script>

    <script>
        // Variables globales
        let isMining = false;
        let miningSession = null;
        let miningInterval = null;
        let sessionStartTime = null;
        
        // Elementos del DOM
        const elements = {
            connectionStatus: document.getElementById('connectionStatus'),
            supabaseStatus: document.getElementById('supabaseStatus'),
            authStatus: document.getElementById('authStatus'),
            miningStatus: document.getElementById('miningStatus'),
            startMiningBtn: document.getElementById('startMiningBtn'),
            stopMiningBtn: document.getElementById('stopMiningBtn'),
            claimBtn: document.getElementById('claimBtn'),
            hashRate: document.getElementById('hashRate'),
            minedRSC: document.getElementById('minedRSC'),
            activeTime: document.getElementById('activeTime'),
            userLevel: document.getElementById('userLevel'),
            sessionProgress: document.getElementById('sessionProgress'),
            sessionTimeRemaining: document.getElementById('sessionTimeRemaining'),
            minersStatus: document.getElementById('minersStatus'),
            transactionsStatus: document.getElementById('transactionsStatus'),
            sessionsStatus: document.getElementById('sessionsStatus'),
            logContainer: document.getElementById('logContainer')
        };

        // Funci√≥n para agregar logs
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            elements.logContainer.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
        }

        // Funci√≥n para limpiar log
        function clearLog() {
            elements.logContainer.innerHTML = '';
            addLog('Log limpiado', 'info');
        }

        // Funci√≥n para actualizar estado de conexi√≥n
        function updateConnectionStatus(connected) {
            const status = elements.connectionStatus;
            if (connected) {
                status.className = 'status-indicator status-connected';
                status.textContent = '‚óè';
            } else {
                status.className = 'status-indicator status-disconnected';
                status.textContent = '‚óè';
            }
        }

        // Test de conexi√≥n a Supabase
        async function testSupabaseConnection() {
            try {
                addLog('Probando conexi√≥n a Supabase...', 'info');
                
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    elements.supabaseStatus.textContent = '‚úÖ Conectado';
                    elements.supabaseStatus.style.color = '#4ecdc4';
                    addLog('‚úÖ Conexi√≥n a Supabase exitosa', 'success');
                    updateConnectionStatus(true);
                } else {
                    elements.supabaseStatus.textContent = '‚ùå No conectado';
                    elements.supabaseStatus.style.color = '#ff6b6b';
                    addLog('‚ùå No se pudo conectar a Supabase', 'error');
                    updateConnectionStatus(false);
                }
            } catch (error) {
                addLog(`‚ùå Error en test de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Test de autenticaci√≥n
        async function testAuthentication() {
            try {
                addLog('Probando sistema de autenticaci√≥n...', 'info');
                
                if (window.authManager && window.authManager.isUserAuthenticated()) {
                    const user = window.authManager.getUser();
                    elements.authStatus.textContent = `‚úÖ Autenticado como ${user.name}`;
                    elements.authStatus.style.color = '#4ecdc4';
                    addLog(`‚úÖ Usuario autenticado: ${user.name}`, 'success');
                } else {
                    elements.authStatus.textContent = '‚ùå No autenticado';
                    elements.authStatus.style.color = '#ff6b6b';
                    addLog('‚ùå Usuario no autenticado', 'warning');
                }
            } catch (error) {
                addLog(`‚ùå Error en test de autenticaci√≥n: ${error.message}`, 'error');
            }
        }

        // Forzar autenticaci√≥n
        async function forceAuthentication() {
            try {
                addLog('üîê Forzando autenticaci√≥n...', 'info');
                
                if (window.authManager) {
                    await window.authManager.autoAuthenticate();
                    
                    // Verificar estado despu√©s de la autenticaci√≥n
                    setTimeout(() => {
                        testAuthentication();
                    }, 1000);
                    
                    addLog('‚úÖ Autenticaci√≥n forzada completada', 'success');
                } else {
                    addLog('‚ùå Auth Manager no disponible', 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error forzando autenticaci√≥n: ${error.message}`, 'error');
            }
        }

        // Test del sistema de miner√≠a
        async function testMiningSystem() {
            try {
                addLog('Probando sistema de miner√≠a...', 'info');
                
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    elements.miningStatus.textContent = '‚úÖ Sistema disponible';
                    elements.miningStatus.style.color = '#4ecdc4';
                    addLog('‚úÖ Sistema de miner√≠a disponible', 'success');
                } else {
                    elements.miningStatus.textContent = '‚ùå Sistema no disponible';
                    elements.miningStatus.style.color = '#ff6b6b';
                    addLog('‚ùå Sistema de miner√≠a no disponible', 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error en test de miner√≠a: ${error.message}`, 'error');
            }
        }

        // Test de tabla Miners
        async function testMinersTable() {
            try {
                addLog('Probando acceso a tabla Miners...', 'info');
                
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    const stats = await window.supabaseMining.getMinerStats();
                    if (stats) {
                        elements.minersStatus.textContent = '‚úÖ Accesible';
                        elements.minersStatus.style.color = '#4ecdc4';
                        addLog(`‚úÖ Tabla Miners accesible - Usuario: ${stats.name}`, 'success');
                    } else {
                        elements.minersStatus.textContent = '‚ö†Ô∏è Sin datos';
                        elements.minersStatus.style.color = '#feca57';
                        addLog('‚ö†Ô∏è Tabla Miners accesible pero sin datos', 'warning');
                    }
                } else {
                    elements.minersStatus.textContent = '‚ùå No accesible';
                    elements.minersStatus.style.color = '#ff6b6b';
                    addLog('‚ùå No se puede acceder a la tabla Miners', 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error en test de tabla Miners: ${error.message}`, 'error');
            }
        }

        // Test de tabla Transactions
        async function testTransactionsTable() {
            try {
                addLog('Probando acceso a tabla Transactions...', 'info');
                
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    const history = await window.supabaseMining.getMiningHistory();
                    elements.transactionsStatus.textContent = `‚úÖ Accesible (${history.length} transacciones)`;
                    elements.transactionsStatus.style.color = '#4ecdc4';
                    addLog(`‚úÖ Tabla Transactions accesible - ${history.length} transacciones`, 'success');
                } else {
                    elements.transactionsStatus.textContent = '‚ùå No accesible';
                    elements.transactionsStatus.style.color = '#ff6b6b';
                    addLog('‚ùå No se puede acceder a la tabla Transactions', 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error en test de tabla Transactions: ${error.message}`, 'error');
            }
        }

        // Test de tabla Sessions
        async function testSessionsTable() {
            try {
                addLog('Probando acceso a tabla Sessions...', 'info');
                
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    elements.sessionsStatus.textContent = '‚úÖ Accesible';
                    elements.sessionsStatus.style.color = '#4ecdc4';
                    addLog('‚úÖ Tabla Sessions accesible', 'success');
                } else {
                    elements.sessionsStatus.textContent = '‚ùå No accesible';
                    elements.sessionsStatus.style.color = '#ff6b6b';
                    addLog('‚ùå No se puede acceder a la tabla Sessions', 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error en test de tabla Sessions: ${error.message}`, 'error');
            }
        }

        // Iniciar miner√≠a
        async function startMining() {
            try {
                if (isMining) {
                    addLog('‚ö†Ô∏è La miner√≠a ya est√° activa', 'warning');
                    return;
                }

                addLog('üöÄ Iniciando miner√≠a...', 'info');
                
                // Crear sesi√≥n de miner√≠a
                miningSession = {
                    id: 'test_session_' + Date.now(),
                    startTime: new Date().toISOString(),
                    endTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    hashPower: 5,
                    totalTokens: 0,
                    isActive: true
                };
                
                sessionStartTime = Date.now();
                isMining = true;
                
                // Actualizar UI
                elements.startMiningBtn.disabled = true;
                elements.stopMiningBtn.disabled = false;
                elements.claimBtn.disabled = true;
                
                // Iniciar sesi√≥n en Supabase
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    try {
                        await window.supabaseMining.startMiningSession(miningSession);
                        addLog('‚úÖ Sesi√≥n de miner√≠a iniciada en Supabase', 'success');
                    } catch (error) {
                        addLog(`‚ö†Ô∏è No se pudo iniciar sesi√≥n en Supabase: ${error.message}`, 'warning');
                    }
                }
                
                // Iniciar c√°lculo de tokens
                startTokenCalculation();
                
                addLog('‚úÖ Miner√≠a iniciada correctamente', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error iniciando miner√≠a: ${error.message}`, 'error');
            }
        }

        // Detener miner√≠a
        async function stopMining() {
            try {
                if (!isMining) {
                    addLog('‚ö†Ô∏è No hay miner√≠a activa', 'warning');
                    return;
                }

                addLog('‚èπÔ∏è Deteniendo miner√≠a...', 'info');
                
                isMining = false;
                
                // Finalizar sesi√≥n en Supabase
                if (window.supabaseMining && window.supabaseMining.isConnected && miningSession) {
                    try {
                        await window.supabaseMining.completeMiningSession(
                            miningSession.id,
                            {
                                totalTokens: miningSession.totalTokens,
                                hashPower: miningSession.hashPower
                            }
                        );
                        addLog('‚úÖ Sesi√≥n de miner√≠a completada en Supabase', 'success');
                    } catch (error) {
                        addLog(`‚ö†Ô∏è No se pudo completar sesi√≥n en Supabase: ${error.message}`, 'warning');
                    }
                }
                
                // Actualizar UI
                elements.startMiningBtn.disabled = false;
                elements.stopMiningBtn.disabled = true;
                elements.claimBtn.disabled = miningSession.totalTokens <= 0;
                
                // Detener c√°lculo de tokens
                if (miningInterval) {
                    clearInterval(miningInterval);
                    miningInterval = null;
                }
                
                addLog('‚úÖ Miner√≠a detenida correctamente', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error deteniendo miner√≠a: ${error.message}`, 'error');
            }
        }

        // Reclamar recompensas
        async function claimRewards() {
            try {
                if (!miningSession || miningSession.totalTokens <= 0) {
                    addLog('‚ö†Ô∏è No hay recompensas para reclamar', 'warning');
                    return;
                }

                addLog('üéÅ Reclamando recompensas...', 'info');
                
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    try {
                        const claimedAmount = await window.supabaseMining.claimRewards();
                        addLog(`‚úÖ Recompensas reclamadas: ${claimedAmount} RSC`, 'success');
                        
                        // Resetear tokens
                        miningSession.totalTokens = 0;
                        elements.minedRSC.textContent = '0.000000 RSC';
                        elements.claimBtn.disabled = true;
                        
                    } catch (error) {
                        addLog(`‚ùå Error reclamando recompensas: ${error.message}`, 'error');
                    }
                } else {
                    addLog('‚ö†Ô∏è Supabase no disponible para reclamar recompensas', 'warning');
                }
                
            } catch (error) {
                addLog(`‚ùå Error en claim de recompensas: ${error.message}`, 'error');
            }
        }

        // Actualizar datos
        async function refreshData() {
            try {
                addLog('üîÑ Actualizando datos...', 'info');
                
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    // Actualizar estad√≠sticas del usuario
                    const stats = await window.supabaseMining.getMinerStats();
                    if (stats) {
                        elements.hashRate.textContent = `${stats.hash_power * 1000} H/s`;
                        elements.minedRSC.textContent = `${stats.balance.toFixed(6)} RSC`;
                        elements.userLevel.textContent = `Nivel ${calculateLevel(stats.balance)}`;
                        addLog('‚úÖ Datos actualizados desde Supabase', 'success');
                    }
                } else {
                    addLog('‚ö†Ô∏è Supabase no disponible para actualizar datos', 'warning');
                }
                
            } catch (error) {
                addLog(`‚ùå Error actualizando datos: ${error.message}`, 'error');
            }
        }

        // Calcular tokens
        function startTokenCalculation() {
            if (miningInterval) {
                clearInterval(miningInterval);
            }
            
            miningInterval = setInterval(() => {
                if (isMining && miningSession && sessionStartTime) {
                    const elapsed = (Date.now() - sessionStartTime) / 1000;
                    const baseRate = 0.001;
                    const hashMultiplier = miningSession.hashPower / 5;
                    const timeMultiplier = Math.min(elapsed / 3600, 24);
                    
                    miningSession.totalTokens = baseRate * hashMultiplier * timeMultiplier;
                    
                    // Actualizar UI
                    elements.minedRSC.textContent = `${miningSession.totalTokens.toFixed(6)} RSC`;
                    elements.activeTime.textContent = formatTime(elapsed);
                    elements.userLevel.textContent = `Nivel ${calculateLevel(miningSession.totalTokens)}`;
                    
                    // Actualizar barra de progreso
                    const totalDuration = 24 * 60 * 60 * 1000;
                    const progress = Math.min((elapsed * 1000 / totalDuration) * 100, 100);
                    elements.sessionProgress.style.width = `${progress}%`;
                    
                    // Actualizar tiempo restante
                    const remaining = Math.max(totalDuration - (elapsed * 1000), 0);
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    elements.sessionTimeRemaining.textContent = `${hours}h ${minutes}m restantes`;
                    
                    // Habilitar bot√≥n de reclamar si hay tokens
                    elements.claimBtn.disabled = miningSession.totalTokens <= 0;
                    
                    // Sincronizar con Supabase cada 30 segundos
                    if (Math.floor(elapsed) % 30 === 0) {
                        if (window.supabaseMining && window.supabaseMining.isConnected) {
                            window.supabaseMining.updateMiningProgress(
                                miningSession.id,
                                {
                                    totalTokens: miningSession.totalTokens,
                                    hashPower: miningSession.hashPower,
                                    elapsed: elapsed
                                }
                            );
                        }
                    }
                }
            }, 1000);
        }

        // Funci√≥n para calcular nivel
        function calculateLevel(tokens) {
            if (tokens < 10) return 1;
            if (tokens < 50) return 2;
            if (tokens < 100) return 3;
            if (tokens < 500) return 4;
            if (tokens < 1000) return 5;
            return Math.floor(tokens / 200) + 5;
        }

        // Funci√≥n para formatear tiempo
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Inicializaci√≥n
        window.addEventListener('load', async () => {
            addLog('üöÄ Inicializando sistema de pruebas...', 'info');
            
            // Esperar a que Supabase est√© disponible
            let attempts = 0;
            const maxAttempts = 50;
            
            const checkSupabase = setInterval(() => {
                attempts++;
                
                if (window.supabaseMining && window.supabaseMining.isConnected) {
                    clearInterval(checkSupabase);
                    addLog('‚úÖ Supabase detectado y conectado', 'success');
                    updateConnectionStatus(true);
                    
                    // Ejecutar tests autom√°ticamente
                    setTimeout(() => {
                        testSupabaseConnection();
                        testAuthentication();
                        testMiningSystem();
                        testMinersTable();
                        testTransactionsTable();
                        testSessionsTable();
                    }, 1000);
                    
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkSupabase);
                    addLog('‚ùå Timeout esperando Supabase', 'error');
                    updateConnectionStatus(false);
                }
            }, 100);
        });

        // Event listeners de Supabase
        window.addEventListener('supabase:connected', (event) => {
            addLog('üîó Evento: Supabase conectado', 'success');
            updateConnectionStatus(true);
        });

        window.addEventListener('supabase:error', (event) => {
            addLog(`‚ùå Evento: Error de Supabase - ${event.detail.error}`, 'error');
            updateConnectionStatus(false);
        });

        // Event listeners de Autenticaci√≥n
        window.addEventListener('auth:user:authenticated', (event) => {
            addLog(`üîê Evento: Usuario autenticado - ${event.detail.user.name}`, 'success');
            testAuthentication();
        });

        window.addEventListener('auth:user:synced', (event) => {
            addLog(`üîÑ Evento: Usuario sincronizado con Supabase - ${event.detail.user.name}`, 'success');
        });

        window.addEventListener('mining:stats:updated', (event) => {
            addLog('üìä Evento: Estad√≠sticas de miner√≠a actualizadas', 'info');
        });

        window.addEventListener('mining:rewards:claimed', (event) => {
            addLog(`üéÅ Evento: Recompensas reclamadas - ${event.detail.amount} RSC`, 'success');
        });
    </script>
</body>
</html>
