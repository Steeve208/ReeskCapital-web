<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Final - RSC Mining</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
        }
        .status.connected { background: #4CAF50; color: white; }
        .status.disconnected { background: #f44336; color: white; }
        .status.connecting { background: #ff9800; color: white; }
        .status.error { background: #9c27b0; color: white; }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            color: #ccc;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üîß Test Supabase Final - RSC Mining</h1>
    
    <div class="test-section">
        <h2>üì° Connection Status</h2>
        <div id="connection-status" class="status connecting">üîÑ Initializing Supabase...</div>
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
        </div>
        <button onclick="testConnection()" id="test-btn" disabled>Test Connection</button>
        <button onclick="manualInit()" id="manual-btn">Manual Initialization</button>
        <button onclick="resetSystem()" id="reset-btn">Reset System</button>
    </div>

    <div class="test-section">
        <h2>üìä System Statistics</h2>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="attempts">0</div>
                <div class="stat-label">Attempts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="success-rate">0%</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="last-success">N/A</div>
                <div class="stat-label">Last Success</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uptime">0s</div>
                <div class="stat-label">Uptime</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>‚õèÔ∏è Mining System Test</h2>
        <button onclick="testMiningSystem()" id="mining-btn" disabled>Test Mining System</button>
        <div id="mining-result"></div>
    </div>

    <div class="test-section">
        <h2>üìä Database Test</h2>
        <button onclick="testDatabase()" id="db-btn" disabled>Test Database</button>
        <div id="database-result"></div>
    </div>

    <div class="test-section">
        <h2>üìù Event Log</h2>
        <div id="event-log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="exportLog()">Export Log</button>
    </div>

    <!-- Most reliable Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <script>
        // System variables
        let supabaseClient = null;
        let isConnected = false;
        let systemStats = {
            attempts: 0,
            successes: 0,
            failures: 0,
            startTime: Date.now(),
            lastSuccess: null
        };
        let initInterval = null;
        let progressInterval = null;

        // DOM elements
        const elements = {
            status: document.getElementById('connection-status'),
            progress: document.getElementById('progress-fill'),
            testBtn: document.getElementById('test-btn'),
            manualBtn: document.getElementById('manual-btn'),
            resetBtn: document.getElementById('reset-btn'),
            miningBtn: document.getElementById('mining-btn'),
            dbBtn: document.getElementById('db-btn'),
            attempts: document.getElementById('attempts'),
            successRate: document.getElementById('success-rate'),
            lastSuccess: document.getElementById('last-success'),
            uptime: document.getElementById('uptime')
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('event-log').innerHTML = '';
        }

        function exportLog() {
            const logContent = document.getElementById('event-log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `supabase-test-log-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateConnectionStatus(status, message) {
            elements.status.className = `status ${status}`;
            elements.status.innerHTML = message;
            isConnected = (status === 'connected');
            
            // Habilitar/deshabilitar botones seg√∫n el estado
            elements.testBtn.disabled = !isConnected;
            elements.miningBtn.disabled = !isConnected;
            elements.dbBtn.disabled = !isConnected;
        }

        function updateStats() {
            elements.attempts.textContent = systemStats.attempts;
            const rate = systemStats.attempts > 0 ? Math.round((systemStats.successes / systemStats.attempts) * 100) : 0;
            elements.successRate.textContent = `${rate}%`;
            elements.lastSuccess.textContent = systemStats.lastSuccess ? systemStats.lastSuccess.toLocaleTimeString() : 'N/A';
            
            const uptime = Math.floor((Date.now() - systemStats.startTime) / 1000);
            elements.uptime.textContent = `${uptime}s`;
        }

        function startProgressBar() {
            let progress = 0;
            elements.progress.style.width = '0%';
            
            progressInterval = setInterval(() => {
                progress += 2;
                if (progress > 100) progress = 100;
                elements.progress.style.width = `${progress}%`;
                
                if (progress === 100) {
                    clearInterval(progressInterval);
                }
            }, 100);
        }

        function stopProgressBar() {
            if (progressInterval) {
                clearInterval(progressInterval);
                elements.progress.style.width = '100%';
            }
        }

        function initializeSupabase() {
            try {
                log('üîÑ Attempting to initialize Supabase...', 'info');
                systemStats.attempts++;
                
                // Verificar si Supabase est√° disponible
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase is not available in window.supabase');
                }
                
                log('‚úÖ Supabase detected in window.supabase', 'success');
                
                // Crear cliente
                supabaseClient = window.supabase.createClient(
                    'https://unevdceponbnmhvpzlzf.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZXZkY2Vwb25ibm1odnB6bHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MTIyMTksImV4cCI6MjA3MTQ4ODIxOX0.OLHbZrezgBiXWQplN1jrGD_xkARqG2uD8ECqzo05jE4'
                );
                
                log('‚úÖ Supabase client created successfully', 'success');
                systemStats.successes++;
                systemStats.lastSuccess = new Date();
                updateStats();
                return true;
                
            } catch (error) {
                log(`‚ùå Error initializing Supabase: ${error.message}`, 'error');
                systemStats.failures++;
                updateStats();
                return false;
            }
        }

        async function testConnection() {
            if (!supabaseClient) {
                log('‚ö†Ô∏è First initialize Supabase', 'warning');
                return;
            }

            log('üîÑ Testing connection...', 'info');
            startProgressBar();
            
            try {
                // Test simple de conexi√≥n
                const { data, error } = await supabaseClient
                    .from('miners')
                    .select('count')
                    .limit(1);
                
                stopProgressBar();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        log('‚ÑπÔ∏è Table "miners" does not exist, but connection works', 'warning');
                        updateConnectionStatus('connected', '‚úÖ Connected (table does not exist)');
                    } else {
                        log(`‚ùå Connection error: ${error.message}`, 'error');
                        updateConnectionStatus('error', '‚ùå Connection error');
                    }
                } else {
                    log('‚úÖ Successful connection to Supabase', 'success');
                    updateConnectionStatus('connected', '‚úÖ Connected to Supabase');
                }
            } catch (error) {
                stopProgressBar();
                log(`‚ùå Exception in test: ${error.message}`, 'error');
                updateConnectionStatus('error', '‚ùå Connection error');
            }
        }

        async function testMiningSystem() {
            if (!isConnected) {
                log('‚ö†Ô∏è First initialize Supabase', 'warning');
                return;
            }

            const resultDiv = document.getElementById('mining-result');
            resultDiv.innerHTML = '<p>üîÑ Testing mining system...</p>';
            log('üîÑ Testing mining system...', 'info');
            
            try {
                // Test de inserci√≥n de minero
                const { data, error } = await supabaseClient
                    .from('miners')
                    .insert([
                        {
                            email: 'test@mining.com',
                            name: 'Test Miner',
                            hash_power: 100,
                            balance: 0,
                            created_at: new Date().toISOString(),
                            last_active: new Date().toISOString()
                        }
                    ])
                    .select();
                
                if (error) {
                    resultDiv.innerHTML = `<p class="error">‚ùå Mining system error: ${error.message}</p>`;
                    log(`‚ùå Mining error: ${error.message}`, 'error');
                } else {
                    resultDiv.innerHTML = '<p class="success">‚úÖ Mining system working</p>';
                    log('‚úÖ Mining system working correctly', 'success');
                    
                    // Limpiar el test
                    await supabaseClient.from('miners').delete().eq('email', 'test@mining.com');
                    log('üßπ Test cleanup completed', 'info');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Exception in mining: ${error.message}</p>`;
                log(`‚ùå Exception in mining: ${error.message}`, 'error');
            }
        }

        async function testDatabase() {
            if (!isConnected) {
                log('‚ö†Ô∏è First initialize Supabase', 'warning');
                return;
            }

            const resultDiv = document.getElementById('database-result');
            resultDiv.innerHTML = '<p>üîÑ Testing database...</p>';
            log('üîÑ Testing database...', 'info');
            
            try {
                // Test de estructura de tablas
                const tables = ['miners', 'mining_transactions'];
                let allTablesExist = true;
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabaseClient.from(table).select('*').limit(1);
                        if (error) {
                            log(`‚ùå Table ${table} does not exist or is inaccessible: ${error.message}`, 'error');
                            allTablesExist = false;
                        } else {
                            log(`‚úÖ Table ${table} accessible`, 'success');
                        }
                    } catch (e) {
                        log(`‚ùå Error accessing table ${table}: ${e.message}`, 'error');
                        allTablesExist = false;
                    }
                }
                
                if (allTablesExist) {
                    resultDiv.innerHTML = '<p class="success">‚úÖ All tables are accessible</p>';
                } else {
                    resultDiv.innerHTML = '<p class="warning">‚ö†Ô∏è Some tables are inaccessible</p>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Database test error: ${error.message}</p>`;
                log(`‚ùå Database test error: ${error.message}`, 'error');
            }
        }

        function manualInit() {
            log('üîß Manual initialization requested', 'info');
            if (initializeSupabase()) {
                updateConnectionStatus('connecting', 'üîÑ Initialized, testing connection...');
                setTimeout(() => {
                    testConnection();
                }, 1000);
            } else {
                updateConnectionStatus('disconnected', '‚ùå Initialization failed');
            }
        }

        function resetSystem() {
            log('üîÑ Resetting system...', 'info');
            
            // Limpiar intervalos
            if (initInterval) clearInterval(initInterval);
            if (progressInterval) clearInterval(progressInterval);
            
            // Resetear variables
            supabaseClient = null;
            isConnected = false;
            systemStats = {
                attempts: 0,
                successes: 0,
                failures: 0,
                startTime: Date.now(),
                lastSuccess: null
            };
            
            // Resetear UI
            updateConnectionStatus('connecting', 'üîÑ System reset');
            elements.progress.style.width = '0%';
            updateStats();
            
            // Reiniciar
            setTimeout(() => {
                startAutoInit();
            }, 1000);
        }

        function startAutoInit() {
            log('ÔøΩÔøΩ Starting automatic initialization...', 'info');
            
            // Verificar Supabase cada 2 segundos
            initInterval = setInterval(() => {
                if (typeof window.supabase !== 'undefined' && !supabaseClient) {
                    log('üéâ Supabase detected automatically', 'success');
                    clearInterval(initInterval);
                    manualInit();
                }
            }, 2000);
        }

        // Auto-inicializaci√≥n al cargar
        window.addEventListener('load', () => {
            log('üöÄ Page loaded, starting system...', 'info');
            updateStats();
            startAutoInit();
        });

        // Actualizar stats cada segundo
        setInterval(updateStats, 1000);
    </script>
</body>
</html>
