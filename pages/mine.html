<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSC Mining - Sistema Integrado</title>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <!-- CSS Redise√±ado -->
    <link rel="stylesheet" href="../styles/mining-redesigned.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- ========================================
         NAVBAR PROFESIONAL Y ELEGANTE
         ======================================== -->
    <nav class="navbar-elegant">
        <div class="nav-container">
            <!-- Logo Elegante -->
            <a href="../index.html" class="nav-logo">
                <div class="logo-icon">‚ö°</div>
                <span class="logo-text">RSC CHAIN</span>
            </a>
            
            <!-- Navegaci√≥n Principal -->
            <div class="nav-links">
                <a href="../index.html" class="nav-link">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="wallet.html" class="nav-link">
                    <span class="nav-icon">üëõ</span>
                    <span class="nav-text">Wallet</span>
                </a>
                <a href="mine.html" class="nav-link active">
                    <span class="nav-icon">‚õèÔ∏è</span>
                    <span class="nav-text">Mine</span>
                </a>
                <a href="p2p.html" class="nav-link">
                    <span class="nav-icon">ü§ù</span>
                    <span class="nav-text">P2P</span>
                </a>
                <a href="staking.html" class="nav-link">
                    <span class="nav-icon">üí∞</span>
                    <span class="nav-text">Staking</span>
                </a>
            </div>
            
            <!-- Acciones del Usuario -->
            <div class="nav-actions">
                <button class="action-btn theme-toggle" id="themeToggle" title="Cambiar tema">
                    <span class="action-icon">üåô</span>
                </button>
                <a href="#" class="action-btn login-btn" id="loginBtn" title="Iniciar sesi√≥n">
                    <span class="action-icon">üë§</span>
                </a>
                <a href="#" class="action-btn wallet-btn" id="walletConnectBtn" title="Conectar wallet">
                    <span class="action-icon">üîí</span>
                </a>
            </div>
            
            <!-- Men√∫ M√≥vil -->
            <button class="nav-toggle" id="navToggle" aria-label="Men√∫ de navegaci√≥n">
                <span class="toggle-line"></span>
                <span class="toggle-line"></span>
                <span class="toggle-line"></span>
            </button>
        </div>
        
        <!-- Men√∫ M√≥vil Desplegable -->
        <div class="mobile-nav" id="mobileNav">
            <div class="mobile-nav-header">
                <span class="mobile-logo">‚ö° RSC CHAIN</span>
                <button class="mobile-close" id="mobileClose">√ó</button>
            </div>
            <div class="mobile-nav-links">
                <a href="../index.html" class="mobile-link">
                    <span class="mobile-icon">üè†</span>
                    <span>Home</span>
                </a>
                <a href="wallet.html" class="mobile-link">
                    <span class="mobile-icon">üëõ</span>
                    <span>Wallet</span>
                </a>
                <a href="mine.html" class="mobile-link active">
                    <span class="mobile-icon">‚õèÔ∏è</span>
                    <span>Mine</span>
                </a>
                <a href="p2p.html" class="mobile-link">
                    <span class="mobile-icon">ü§ù</span>
                    <span>P2P</span>
                </a>
                <a href="staking.html" class="mobile-link">
                    <span class="mobile-icon">üí∞</span>
                    <span>Staking</span>
                </a>
            </div>
            <div class="mobile-nav-actions">
                <button class="mobile-action-btn theme-toggle" id="mobileThemeToggle">
                    <span>üåô</span>
                    <span>Tema</span>
                </button>
                <a href="#" class="mobile-action-btn login-btn" id="mobileLoginBtn">
                    <span>üë§</span>
                    <span>Login</span>
                </a>
                <a href="#" class="mobile-action-btn wallet-btn" id="mobileWalletConnectBtn">
                    <span>üîí</span>
                    <span>Wallet</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- ========================================
         CONTENEDOR PRINCIPAL DE MINER√çA
         ======================================== -->
    <div class="mining-container">
        <div class="mining-grid">
            
            <!-- ========================================
                 HEADER PRINCIPAL
                 ======================================== -->
            <div class="mining-header">
                <div class="mining-header-content">
                    <div class="mining-title">
                        <div class="lightning-icon">‚ö°</div>
                        <h1>RSC MINING</h1>
                    </div>
                    
                    <div class="connection-status">
                        <div class="connection-dot" id="connectionDot"></div>
                        <span id="connectionStatus">Conectando a Supabase...</span>
                    </div>
                    
                    <div class="session-progress-container">
                        <div class="session-progress-label">
                            <span>Progreso de Sesi√≥n</span>
                            <span id="sessionProgressText">0.0%</span>
                        </div>
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="sessionProgressFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========================================
                 PANEL DE CONTROL PRINCIPAL
                 ======================================== -->
            <div class="control-panel">
                <h2>Controles de Miner√≠a</h2>
                
                <div class="mining-controls">
                    <button class="control-button start" id="startBtn">
                        <i class="fas fa-play"></i>
                        Iniciar Miner√≠a
                    </button>
                    
                    <button class="control-button stop" id="stopBtn" disabled>
                        <i class="fas fa-stop"></i>
                        Detener Miner√≠a
                    </button>
                    
                    <button class="control-button claim" id="claimBtn" disabled>
                        <i class="fas fa-trophy"></i>
                        Reclamar Recompensas
                    </button>
                </div>
                
                <div class="intensity-control">
                    <div class="intensity-label">
                        <span>Intensidad de Miner√≠a</span>
                        <span class="intensity-value" id="intensityValue">4%</span>
                    </div>
                    <input type="range" class="intensity-slider" id="intensitySlider" 
                           min="1" max="100" value="4" step="1">
                </div>
            </div>
            
            <!-- ========================================
                 ESTAD√çSTICAS EN TIEMPO REAL
                 ======================================== -->
            <div class="stats-grid">
                <div class="stat-card tokens">
                    <div class="stat-icon">ü™ô</div>
                    <div class="stat-value" id="tokensMined">0.0000</div>
                    <div class="stat-label">RSC Minados</div>
                </div>
                
                <div class="stat-card hashrate">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="currentHashRate">0 H/s</div>
                    <div class="stat-label">Hash Rate</div>
                </div>
                
                <div class="stat-card efficiency">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="efficiency">0.0%</div>
                    <div class="stat-label">Eficiencia</div>
                </div>
                
                <div class="stat-card session-time">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="sessionTime">00:00:00</div>
                    <div class="stat-label">Tiempo de Sesi√≥n</div>
                </div>
            </div>
            
            <!-- ========================================
                 PANEL DERECHO - INFORMACI√ìN
                 ======================================== -->
            <div class="right-panel">
                
                <!-- Estado del Sistema -->
                <div class="info-card system-status" id="systemStatusCard">
                    <h3>
                        <i class="fas fa-server"></i>
                        Estado del Sistema
                    </h3>
                    <div class="status-indicator" id="systemIndicator"></div>
                    <span id="systemStatus">Inicializando sistema...</span>
                </div>
                
                <!-- Consejos de Optimizaci√≥n -->
                <div class="info-card optimization-tips">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        Consejos de Optimizaci√≥n
                    </h3>
                    <ul class="tips-list">
                        <li>Usa un navegador moderno (Chrome, Firefox, Edge)</li>
                        <li>Mant√©n tu dispositivo conectado a la corriente</li>
                        <li>Aseg√∫rate de tener una conexi√≥n estable a internet</li>
                        <li>Las sesiones de 24 horas dan mejores recompensas</li>
                        <li>La miner√≠a funciona en m√≥viles y tablets</li>
                    </ul>
                </div>
                
                <!-- Historial de Sesiones -->
                <div class="info-card session-history">
                    <h3>
                        <i class="fas fa-history"></i>
                        Historial de Sesiones
                    </h3>
                    <table class="history-table" id="sessionHistoryTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Duraci√≥n</th>
                                <th>Tokens</th>
                            </tr>
                        </thead>
                        <tbody id="sessionHistoryBody">
                            <tr>
                                <td colspan="3" style="text-align: center; color: var(--text-secondary);">
                                    No hay sesiones registradas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
            </div>
            
        </div>
    </div>
    
    <!-- ========================================
         SCRIPTS DE INTEGRACI√ìN
         ======================================== -->
    
    <!-- Supabase Mining Integration -->
    <script src="../scripts/supabase-mining-integration.js"></script>
    
    <!-- Mining UI Manager -->
    <script src="../scripts/mining-ui-manager.js"></script>
    
    <!-- Auth Manager -->
    <script src="../scripts/auth-manager.js"></script>
    
    <!-- Script Principal de Miner√≠a -->
    <script>
        // ========================================
        // NAVBAR FUNCTIONALITY
        // ========================================
        
        // Mobile menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const navToggle = document.getElementById('navToggle');
            const mobileNav = document.getElementById('mobileNav');
            const mobileClose = document.getElementById('mobileClose');
            
            if (navToggle && mobileNav) {
                navToggle.addEventListener('click', function() {
                    mobileNav.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
            }
            
            if (mobileClose && mobileNav) {
                mobileClose.addEventListener('click', function() {
                    mobileNav.classList.remove('active');
                    document.body.style.overflow = '';
                });
            }
            
            // Cerrar men√∫ al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (mobileNav && mobileNav.classList.contains('active')) {
                    if (!mobileNav.contains(e.target) && !navToggle.contains(e.target)) {
                        mobileNav.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
            });
            
            // Theme toggle
            const themeToggles = document.querySelectorAll('.theme-toggle');
            themeToggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    document.body.classList.toggle('light-mode');
                    const icons = document.querySelectorAll('.theme-toggle .action-icon, .mobile-action-btn.theme-toggle span:first-child');
                    icons.forEach(icon => {
                        if (document.body.classList.contains('light-mode')) {
                            icon.textContent = '‚òÄÔ∏è';
                        } else {
                            icon.textContent = 'üåô';
                        }
                    });
                });
            });
        });
        
        // ========================================
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let currentSessionId = null;
        let miningInterval = null;
        let sessionStartTime = null;
        let totalTokens = 0;
        let currentHashRate = 0;
        let intensity = 4;
        
        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Inicializando sistema de miner√≠a redise√±ado...');
            
            try {
                // Inicializar Supabase
                await window.supabaseMining.init();
                
                // Inicializar autenticaci√≥n
                await window.authManager.init();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Inicializar UI
                initializeUI();
                
                console.log('‚úÖ Sistema de miner√≠a inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando sistema:', error);
                updateSystemStatus('Error inicializando sistema', 'error');
            }
        });
        
        // ========================================
        // CONFIGURACI√ìN DE EVENT LISTENERS
        // ========================================
        function setupEventListeners() {
            // Botones de control
            document.getElementById('startBtn').addEventListener('click', startMining);
            document.getElementById('stopBtn').addEventListener('click', stopMining);
            document.getElementById('claimBtn').addEventListener('click', claimRewards);
            
            // Slider de intensidad
            document.getElementById('intensitySlider').addEventListener('input', function(e) {
                intensity = parseInt(e.target.value);
                document.getElementById('intensityValue').textContent = intensity + '%';
                updateHashRate();
            });
            
            // Eventos de Supabase
            document.addEventListener('supabase:connected', handleSupabaseConnected);
            document.addEventListener('supabase:disconnected', handleSupabaseDisconnected);
            document.addEventListener('auth:user:authenticated', handleUserAuthenticated);
            document.addEventListener('auth:user:synced', handleUserSynced);
        }
        
        // ========================================
        // INICIALIZACI√ìN DE UI
        // ======================================== 
        function initializeUI() {
            updateConnectionStatus('Conectando...', 'connecting');
            updateSystemStatus('Sistema listo para miner√≠a', 'ready');
            updateSessionProgress(0);
            
            // Configurar valores iniciales
            updateHashRate();
            updateStats();
        }
        
        // ========================================
        // FUNCIONES DE MINER√çA
        // ========================================
        async function startMining() {
            try {
                console.log('üöÄ Iniciando miner√≠a...');
                
                // Actualizar UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                updateSystemStatus('Iniciando sesi√≥n de miner√≠a...', 'connecting');
                
                // Iniciar sesi√≥n en Supabase
                const sessionData = {
                    email: window.authManager.currentUser?.email || 'user@rsc.local',
                    hash_power: currentHashRate,
                    start_time: new Date().toISOString()
                };
                
                currentSessionId = await window.supabaseMining.startMiningSession(sessionData);
                
                if (currentSessionId) {
                    // Iniciar simulaci√≥n local
                    startMiningSimulation();
                    
                    // Actualizar estado
                    updateSystemStatus('Miner√≠a activa. Sincronizando con la base de datos...', 'active');
                    sessionStartTime = Date.now();
                    
                    console.log('‚úÖ Miner√≠a iniciada correctamente. Session ID:', currentSessionId);
                } else {
                    throw new Error('No se pudo crear la sesi√≥n de miner√≠a');
                }
                
            } catch (error) {
                console.error('‚ùå Error iniciando miner√≠a:', error);
                updateSystemStatus('Error iniciando miner√≠a: ' + error.message, 'error');
                
                // Restaurar botones
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }
        
        async function stopMining() {
            try {
                console.log('üõë Deteniendo miner√≠a...');
                
                // Detener simulaci√≥n local
                stopMiningSimulation();
                
                // Actualizar UI
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                updateSystemStatus('Finalizando sesi√≥n de miner√≠a...', 'connecting');
                
                // Completar sesi√≥n en Supabase
                if (currentSessionId) {
                    const finalData = {
                        session_id: currentSessionId,
                        total_tokens: totalTokens,
                        hash_power: currentHashRate,
                        end_time: new Date().toISOString()
                    };
                    
                    await window.supabaseMining.completeMiningSession(finalData);
                    
                    // Crear transacci√≥n de miner√≠a
                    await window.supabaseMining.createMiningTransaction({
                        email: window.authManager.currentUser?.email || 'user@rsc.local',
                        hash_power: currentHashRate,
                        reward: totalTokens,
                        block_hash: generateBlockHash()
                    });
                    
                    console.log('‚úÖ Sesi√≥n de miner√≠a completada. Tokens minados:', totalTokens);
                }
                
                // Actualizar estado
                updateSystemStatus('Miner√≠a detenida. Sesi√≥n guardada correctamente.', 'ready');
                
                // Habilitar bot√≥n de reclamar
                document.getElementById('claimBtn').disabled = false;
                
                // Resetear variables
                currentSessionId = null;
                sessionStartTime = null;
                
            } catch (error) {
                console.error('‚ùå Error deteniendo miner√≠a:', error);
                updateSystemStatus('Error deteniendo miner√≠a: ' + error.message, 'error');
            }
        }
        
        async function claimRewards() {
            try {
                console.log('üèÜ Reclamando recompensas...');
                
                if (totalTokens > 0) {
                    await window.supabaseMining.claimRewards(totalTokens);
                    
                    // Actualizar UI
                    updateSystemStatus('Recompensas reclamadas correctamente!', 'success');
                    document.getElementById('claimBtn').disabled = true;
                    
                    // Resetear tokens
                    totalTokens = 0;
                    updateStats();
                    
                    console.log('‚úÖ Recompensas reclamadas:', totalTokens);
                } else {
                    updateSystemStatus('No hay recompensas para reclamar', 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Error reclamando recompensas:', error);
                updateSystemStatus('Error reclamando recompensas: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // SIMULACI√ìN DE MINER√çA
        // ========================================
        function startMiningSimulation() {
            miningInterval = setInterval(() => {
                // Calcular tokens basados en hash rate y tiempo
                const elapsed = (Date.now() - sessionStartTime) / 1000;
                const tokensPerSecond = (currentHashRate * intensity) / 1000000;
                totalTokens += tokensPerSecond;
                
                // Actualizar UI
                updateStats();
                updateSessionProgress((elapsed / 3600) * 100); // Progreso por hora
                
                // Sincronizar con Supabase cada 30 segundos
                if (Math.floor(elapsed) % 30 === 0) {
                    syncProgressWithSupabase();
                }
                
            }, 1000);
        }
        
        function stopMiningSimulation() {
            if (miningInterval) {
                clearInterval(miningInterval);
                miningInterval = null;
            }
        }
        
        // ========================================
        // FUNCIONES DE ACTUALIZACI√ìN DE UI
        // ========================================
        function updateConnectionStatus(status, type = 'connecting') {
            const statusElement = document.getElementById('connectionStatus');
            const dotElement = document.getElementById('connectionDot');
            
            statusElement.textContent = status;
            dotElement.className = 'connection-dot ' + type;
        }
        
        function updateSystemStatus(status, type = 'ready') {
            const statusElement = document.getElementById('systemStatus');
            const cardElement = document.getElementById('systemStatusCard');
            const indicatorElement = document.getElementById('systemIndicator');
            
            statusElement.textContent = status;
            
            // Actualizar clases CSS
            cardElement.className = 'info-card system-status ' + type;
            indicatorElement.className = 'status-indicator ' + type;
        }
        
        function updateSessionProgress(percentage) {
            const progressFill = document.getElementById('sessionProgressFill');
            const progressText = document.getElementById('sessionProgressText');
            
            const clampedPercentage = Math.min(100, Math.max(0, percentage));
            progressFill.style.width = clampedPercentage + '%';
            progressText.textContent = clampedPercentage.toFixed(1) + '%';
        }
        
        function updateHashRate() {
            currentHashRate = 500 * (intensity / 4);
            updateStats();
        }
        
        function updateStats() {
            // Tokens minados
            document.getElementById('tokensMined').textContent = totalTokens.toFixed(4);
            
            // Hash rate
            document.getElementById('currentHashRate').textContent = currentHashRate.toFixed(0) + ' H/s';
            
            // Eficiencia
            const efficiency = Math.min(100, (currentHashRate / 1000) * 100);
            document.getElementById('efficiency').textContent = efficiency.toFixed(1) + '%';
            
            // Tiempo de sesi√≥n
            if (sessionStartTime) {
                const elapsed = Date.now() - sessionStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // ========================================
        // SINCRONIZACI√ìN CON SUPABASE
        // ========================================
        async function syncProgressWithSupabase() {
            if (currentSessionId && window.supabaseMining) {
                try {
                    await window.supabaseMining.updateMiningProgress({
                        session_id: currentSessionId,
                        current_tokens: totalTokens,
                        current_hash_rate: currentHashRate
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error sincronizando progreso:', error);
                }
            }
        }
        
        // ========================================
        // MANEJADORES DE EVENTOS
        // ========================================
        function handleSupabaseConnected() {
            updateConnectionStatus('Conectado a Supabase', 'connected');
            updateSystemStatus('Sistema conectado y listo', 'ready');
        }
        
        function handleSupabaseDisconnected() {
            updateConnectionStatus('Desconectado de Supabase', 'disconnected');
            updateSystemStatus('Error de conexi√≥n con Supabase', 'error');
        }
        
        function handleUserAuthenticated(user) {
            console.log('üë§ Usuario autenticado:', user);
            updateSystemStatus('Usuario autenticado. Sistema listo para miner√≠a.', 'ready');
        }
        
        function handleUserSynced() {
            console.log('üîÑ Usuario sincronizado con Supabase');
            updateSystemStatus('Usuario sincronizado. Todo listo para minar!', 'ready');
        }
        
        // ========================================
        // FUNCIONES UTILITARIAS
        // ========================================
        function generateBlockHash() {
            return '0x' + Math.random().toString(16).substr(2, 64);
        }
        
        // ========================================
        // MANEJO DE ERRORES GLOBAL
        // ========================================
        window.addEventListener('error', function(e) {
            console.error('‚ùå Error global:', e.error);
            updateSystemStatus('Error del sistema: ' + e.error.message, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('‚ùå Promesa rechazada:', e.reason);
            updateSystemStatus('Error de promesa: ' + e.reason, 'error');
        });
        
        // ========================================
        // SISTEMA DE MINER√çA AUTOM√ÅTICA
        // ========================================
        
        // Inicializar sistema de miner√≠a autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si el sistema de miner√≠a autom√°tica est√° disponible
            if (window.autoMiningSystem) {
                console.log('ü§ñ Sistema de Miner√≠a Autom√°tica detectado');
                
                // Sincronizar con el sistema existente
                if (window.autoMiningSystem.miningActive) {
                    console.log('‚õèÔ∏è Miner√≠a autom√°tica ya est√° activa');
                    updateSystemStatus('Miner√≠a autom√°tica funcionando en segundo plano', 'active');
                }
            } else {
                console.log('‚ö†Ô∏è Sistema de Miner√≠a Autom√°tica no disponible');
            }
        });
        
    </script>
    
    <!-- Sistema de Miner√≠a Autom√°tica -->
    <script src="../scripts/auto-mining-system.js"></script>
</body>
</html>
