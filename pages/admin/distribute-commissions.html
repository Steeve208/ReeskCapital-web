<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuir Comisiones de Referidos - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(21, 21, 21, 0.95);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(0, 255, 136, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #a0a0a0;
            margin-bottom: 30px;
        }
        
        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
        }
        
        .warning-box h3 {
            color: #ffc107;
            margin-bottom: 10px;
        }
        
        .warning-box p {
            color: #ffc107;
            line-height: 1.6;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .status-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-box h3 {
            margin-bottom: 15px;
            color: #00ff88;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            color: #a0a0a0;
        }
        
        .status-value {
            color: #ffffff;
            font-weight: 600;
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        
        .log-entry.info {
            color: #00d4ff;
        }
        
        .log-entry.success {
            color: #00ff88;
        }
        
        .log-entry.warning {
            color: #ffc107;
        }
        
        .log-entry.error {
            color: #ff4444;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }
        
        .result-card h4 {
            color: #00ff88;
            margin-bottom: 10px;
        }
        
        .result-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> Distribuir Comisiones de Referidos</h1>
        <p class="subtitle">Procesa todas las comisiones pendientes de referidos para todos los usuarios</p>
        
        <div class="warning-box">
            <h3>锔 Advertencia</h3>
            <p>
                Este script procesar谩 todas las comisiones de referidos pendientes bas谩ndose en el total minado de cada usuario.
                Aseg煤rate de tener una copia de seguridad de la base de datos antes de ejecutar.
            </p>
        </div>
        
        <div class="button-group">
            <button class="btn-secondary" id="simulateBtn" style="background: rgba(255, 193, 7, 0.2); border-color: rgba(255, 193, 7, 0.5); color: #ffc107;">
                <i class="fas fa-vial"></i>
                <span>Simular (Sin Cambios)</span>
            </button>
            <button class="btn-primary" id="startBtn">
                <i class="fas fa-play"></i>
                <span>Distribuir Comisiones (REAL)</span>
            </button>
            <button class="btn-secondary" id="clearLogBtn">
                <i class="fas fa-trash"></i>
                <span>Limpiar Log</span>
            </button>
        </div>
        
        <div class="status-box" id="statusBox" style="display: none;">
            <h3>Estado del Proceso</h3>
            <div id="statusContent"></div>
        </div>
        
        <div class="results-section" id="resultsSection" style="display: none;">
            <h3>Resultados</h3>
            <div class="results-grid" id="resultsGrid"></div>
        </div>
        
        <div>
            <h3>Log de Proceso</h3>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Integration -->
    <script src="../../scripts/supabase-integration.js"></script>
    
    <!-- Admin Script -->
    <script src="../../scripts/admin/distribute-referral-commissions.js"></script>
    
    <script>
        // Interceptar console.log para mostrar en el log container
        const logContainer = document.getElementById('logContainer');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLogEntry(args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLogEntry(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogEntry(args.join(' '), 'warning');
        };
        
        // Botones
        const startBtn = document.getElementById('startBtn');
        const simulateBtn = document.getElementById('simulateBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const statusBox = document.getElementById('statusBox');
        const statusContent = document.getElementById('statusContent');
        const resultsSection = document.getElementById('resultsSection');
        const resultsGrid = document.getElementById('resultsGrid');
        
        // Funci贸n para ejecutar la distribuci贸n
        async function executeDistribution(isDryRun = false) {
            if (!window.distributeReferralCommissions) {
                alert('El script de distribuci贸n no est谩 cargado. Por favor, recarga la p谩gina.');
                return;
            }
            
            if (!isDryRun) {
                const confirmed = confirm('锔 ADVERTENCIA: Esto realizar谩 cambios REALES en la base de datos.\n\n驴Est谩s seguro de que deseas procesar todas las comisiones pendientes?');
                if (!confirmed) return;
            }
            
            const activeBtn = isDryRun ? simulateBtn : startBtn;
            activeBtn.disabled = true;
            activeBtn.innerHTML = '<div class="loading"></div> <span>' + (isDryRun ? 'Simulando...' : 'Procesando...') + '</span>';
            
            statusBox.style.display = 'block';
            statusContent.innerHTML = '<div class="status-item"><span class="status-label">Estado:</span><span class="status-value">' + (isDryRun ? 'Simulando...' : 'Iniciando...') + '</span></div>';
            
            try {
                const result = await window.distributeReferralCommissions(isDryRun);
                
                // Mostrar resultados
                if (result.success) {
                    const statusText = isDryRun ? 'Simulaci贸n Completada' : 'Completado';
                    const statusColor = isDryRun ? '#ffc107' : '#00ff88';
                    const modeText = isDryRun ? '<div class="status-item"><span class="status-label">Modo:</span><span class="status-value" style="color: #ffc107;">И SIMULACIN (Sin cambios reales)</span></div>' : '';
                    
                    statusContent.innerHTML = `
                        <div class="status-item">
                            <span class="status-label">Estado:</span>
                            <span class="status-value" style="color: ${statusColor};">${statusText}</span>
                        </div>
                        ${modeText}
                        <div class="status-item">
                            <span class="status-label">Total de usuarios:</span>
                            <span class="status-value">${result.totalUsers}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Comisiones procesadas:</span>
                            <span class="status-value" style="color: #00ff88;">${result.processed}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Usuarios saltados:</span>
                            <span class="status-value">${result.skipped}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Errores:</span>
                            <span class="status-value" style="color: ${result.errors > 0 ? '#ff4444' : '#00ff88'};">${result.errors}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Total distribuido:</span>
                            <span class="status-value" style="color: #00ff88; font-size: 1.2rem;">${result.totalCommissions.toFixed(6)} RSC</span>
                        </div>
                    `;
                    
                    resultsSection.style.display = 'block';
                    resultsGrid.innerHTML = `
                        <div class="result-card">
                            <h4>Total Procesado</h4>
                            <div class="value">${result.processed}</div>
                        </div>
                        <div class="result-card">
                            <h4>Total Distribuido</h4>
                            <div class="value">${result.totalCommissions.toFixed(6)} RSC</div>
                        </div>
                        <div class="result-card">
                            <h4>Usuarios Saltados</h4>
                            <div class="value">${result.skipped}</div>
                        </div>
                        <div class="result-card">
                            <h4>Errores</h4>
                            <div class="value" style="color: ${result.errors > 0 ? '#ff4444' : '#00ff88'};">${result.errors}</div>
                        </div>
                    `;
                } else {
                    statusContent.innerHTML = `
                        <div class="status-item">
                            <span class="status-label">Estado:</span>
                            <span class="status-value" style="color: #ff4444;">Error</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Mensaje:</span>
                            <span class="status-value">${result.error || 'Error desconocido'}</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error ejecutando distribuci贸n:', error);
                statusContent.innerHTML = `
                    <div class="status-item">
                        <span class="status-label">Estado:</span>
                        <span class="status-value" style="color: #ff4444;">Error</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Mensaje:</span>
                        <span class="status-value">${error.message}</span>
                    </div>
                `;
            } finally {
                activeBtn.disabled = false;
                if (isDryRun) {
                    activeBtn.innerHTML = '<i class="fas fa-vial"></i> <span>Simular (Sin Cambios)</span>';
                } else {
                    activeBtn.innerHTML = '<i class="fas fa-play"></i> <span>Distribuir Comisiones (REAL)</span>';
                }
            }
        }
        
        // Bot贸n de simulaci贸n
        simulateBtn.addEventListener('click', () => {
            executeDistribution(true);
        });
        
        // Bot贸n de distribuci贸n real
        startBtn.addEventListener('click', () => {
            executeDistribution(false);
        });
        
        clearLogBtn.addEventListener('click', () => {
            logContainer.innerHTML = '';
        });
    </script>
</body>
</html>

