<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Persistencia de Miner√≠a RSC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background: rgba(16, 185, 129, 0.3); }
        .status.error { background: rgba(239, 68, 68, 0.3); }
        .status.info { background: rgba(59, 130, 246, 0.3); }
        button {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #d97706; }
        .log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Persistencia de Miner√≠a RSC</h1>
    
    <div class="test-section">
        <h2>üìä Estado Actual</h2>
        <div id="currentStatus" class="status info">Verificando estado...</div>
        <div id="miningInfo" class="status info" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üéÆ Controles de Prueba</h2>
        <button onclick="startMining()">üöÄ Iniciar Miner√≠a</button>
        <button onclick="stopMining()">‚èπÔ∏è Detener Miner√≠a</button>
        <button onclick="checkStatus()">üîç Verificar Estado</button>
        <button onclick="clearData()">üóëÔ∏è Limpiar Datos</button>
        <button onclick="simulateNavigation()">üîÑ Simular Navegaci√≥n</button>
    </div>

    <div class="test-section">
        <h2>üìù Log de Eventos</h2>
        <div id="eventLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üíæ Datos Almacenados</h2>
        <div id="storedData" class="log"></div>
    </div>

    <script>
        // Simular sistema de miner√≠a para testing
        let miningSystem = {
            isMining: false,
            miningSession: null,
            startTime: null,
            sessionDuration: 24 * 60 * 60 * 1000, // 24 horas
            tokenCalculationInterval: null
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.className = `log-entry ${type}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus() {
            const statusDiv = document.getElementById('currentStatus');
            const miningInfoDiv = document.getElementById('miningInfo');
            
            if (miningSystem.isMining && miningSystem.miningSession) {
                const now = new Date();
                const startTime = new Date(miningSystem.startTime);
                const elapsed = now - startTime;
                const remaining = miningSystem.sessionDuration - elapsed;
                
                if (remaining > 0) {
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `‚úÖ Miner√≠a ACTIVA - ${hours}h ${minutes}m restantes`;
                    
                    miningInfoDiv.style.display = 'block';
                    miningInfoDiv.innerHTML = `
                        <strong>Sesi√≥n ID:</strong> ${miningSystem.miningSession.id}<br>
                        <strong>Iniciada:</strong> ${startTime.toLocaleString()}<br>
                        <strong>Tiempo transcurrido:</strong> ${Math.floor(elapsed / (1000 * 60))} minutos<br>
                        <strong>Hash Power:</strong> ${miningSystem.miningSession.hashPower}
                    `;
                } else {
                    statusDiv.className = 'status info';
                    statusDiv.textContent = '‚è∞ Sesi√≥n completada';
                    miningInfoDiv.style.display = 'none';
                }
            } else {
                statusDiv.className = 'status info';
                statusDiv.textContent = '‚ùå No hay miner√≠a activa';
                miningInfoDiv.style.display = 'none';
            }
        }

        function startMining() {
            if (miningSystem.isMining) {
                log('‚ùå La miner√≠a ya est√° activa', 'error');
                return;
            }

            miningSystem.isMining = true;
            miningSystem.startTime = new Date();
            miningSystem.miningSession = {
                id: 'test_' + Date.now(),
                startTime: miningSystem.startTime.toISOString(),
                endTime: new Date(miningSystem.startTime.getTime() + miningSystem.sessionDuration).toISOString(),
                isActive: true,
                hashPower: 5,
                totalTokens: 0
            };

            // Guardar en localStorage
            localStorage.setItem('rsc_mining_data', JSON.stringify({
                isMining: true,
                miningSession: miningSystem.miningSession,
                hashPower: 5,
                startTime: miningSystem.startTime.toISOString()
            }));

            // Iniciar c√°lculo de tokens
            miningSystem.tokenCalculationInterval = setInterval(() => {
                if (miningSystem.isMining && miningSystem.miningSession) {
                    const now = new Date();
                    const startTime = new Date(miningSystem.startTime);
                    const elapsed = (now - startTime) / 1000;
                    const tokensEarned = 0.001 * (miningSystem.miningSession.hashPower / 5) * (elapsed / 3600);
                    
                    miningSystem.miningSession.totalTokens = tokensEarned;
                    
                    // Guardar datos actualizados
                    localStorage.setItem('rsc_mining_data', JSON.stringify({
                        isMining: true,
                        miningSession: miningSystem.miningSession,
                        hashPower: 5,
                        startTime: miningSystem.startTime.toISOString()
                    }));

                    log(`üí∞ Tokens calculados: ${tokensEarned.toFixed(6)} RSC`, 'info');
                }
            }, 1000);

            log('üöÄ Miner√≠a iniciada exitosamente', 'success');
            updateStatus();
        }

        function stopMining() {
            if (!miningSystem.isMining) {
                log('‚ùå No hay miner√≠a activa para detener', 'error');
                return;
            }

            miningSystem.isMining = false;
            if (miningSystem.tokenCalculationInterval) {
                clearInterval(miningSystem.tokenCalculationInterval);
                miningSystem.tokenCalculationInterval = null;
            }

            if (miningSystem.miningSession) {
                miningSystem.miningSession.isActive = false;
                miningSystem.miningSession.endTime = new Date().toISOString();
            }

            // Limpiar localStorage
            localStorage.removeItem('rsc_mining_data');

            log('‚èπÔ∏è Miner√≠a detenida manualmente', 'info');
            updateStatus();
        }

        function checkStatus() {
            log('üîç Verificando estado de miner√≠a...', 'info');
            
            // Verificar localStorage
            const storedData = localStorage.getItem('rsc_mining_data');
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    if (data.miningSession && data.miningSession.isActive) {
                        const session = data.miningSession;
                        const now = new Date();
                        const endTime = new Date(session.endTime);
                        
                        if (now < endTime) {
                            log('‚úÖ Sesi√≥n activa encontrada en localStorage', 'success');
                            
                            // Restaurar estado
                            miningSystem.isMining = true;
                            miningSystem.miningSession = session;
                            miningSystem.startTime = new Date(session.startTime);
                            
                            // Reiniciar c√°lculo de tokens
                            if (!miningSystem.tokenCalculationInterval) {
                                startMining();
                            }
                        } else {
                            log('‚è∞ Sesi√≥n expirada, limpiando datos', 'info');
                            localStorage.removeItem('rsc_mining_data');
                        }
                    }
                } catch (error) {
                    log('‚ùå Error parseando datos almacenados: ' + error.message, 'error');
                }
            } else {
                log('üì≠ No hay datos de miner√≠a almacenados', 'info');
            }
            
            updateStatus();
            updateStoredData();
        }

        function clearData() {
            localStorage.removeItem('rsc_mining_data');
            miningSystem.isMining = false;
            miningSystem.miningSession = null;
            if (miningSystem.tokenCalculationInterval) {
                clearInterval(miningSystem.tokenCalculationInterval);
                miningSystem.tokenCalculationInterval = null;
            }
            
            log('üóëÔ∏è Datos limpiados', 'info');
            updateStatus();
            updateStoredData();
        }

        function simulateNavigation() {
            log('üîÑ Simulando navegaci√≥n a otra p√°gina...', 'info');
            
            // Simular que se va a otra p√°gina
            document.body.style.opacity = '0.3';
            
            setTimeout(() => {
                log('üì± Simulando regreso a la p√°gina...', 'info');
                document.body.style.opacity = '1';
                
                // Verificar estado despu√©s de "regresar"
                setTimeout(() => {
                    checkStatus();
                }, 1000);
            }, 2000);
        }

        function updateStoredData() {
            const dataDiv = document.getElementById('storedData');
            const storedData = localStorage.getItem('rsc_mining_data');
            
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    dataDiv.textContent = JSON.stringify(data, null, 2);
                } catch (error) {
                    dataDiv.textContent = 'Error parseando datos: ' + error.message;
                }
            } else {
                dataDiv.textContent = 'No hay datos almacenados';
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            log('üß™ Sistema de prueba inicializado', 'info');
            checkStatus();
            updateStoredData();
            
            // Verificar estado cada 5 segundos
            setInterval(() => {
                if (miningSystem.isMining) {
                    updateStatus();
                }
            }, 5000);
        });

        // Eventos de visibilidad
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                log('üì± P√°gina oculta', 'info');
            } else {
                log('üì± P√°gina visible', 'info');
                checkStatus();
            }
        });

        // Evento antes de cerrar
        window.addEventListener('beforeunload', () => {
            if (miningSystem.isMining) {
                log('üö™ P√°gina cerrando - Miner√≠a activa', 'info');
                return 'La miner√≠a continuar√° funcionando. ¬øEst√°s seguro?';
            }
        });
    </script>
</body>
</html>
